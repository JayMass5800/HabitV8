<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools">
    <!-- Notification permissions -->
    <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />
    <uses-permission android:name="android.permission.VIBRATE" />
    <uses-permission android:name="android.permission.WAKE_LOCK" />
    <uses-permission android:name="android.permission.RECEIVE_BOOT_COMPLETED" />
    
    <!-- Background service and foreground service permissions -->
    <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
    <uses-permission android:name="android.permission.FOREGROUND_SERVICE_MEDIA_PLAYBACK" />
    <uses-permission android:name="android.permission.FOREGROUND_SERVICE_SPECIAL_USE" />
    
    <!-- Audio permissions for alarm playback -->
    <uses-permission android:name="android.permission.MODIFY_AUDIO_SETTINGS" />
    
    <!-- High priority alarm permissions -->
    <uses-permission android:name="android.permission.DISABLE_KEYGUARD" />
    <uses-permission android:name="android.permission.TURN_SCREEN_ON" />
    <uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW" />
    
    <!-- Exact alarm permissions for Android 16+ (automatically granted) -->
    <uses-permission android:name="android.permission.USE_EXACT_ALARM" />
    
    <!-- Backward compatibility for older Android versions -->
    <uses-permission android:name="android.permission.SCHEDULE_EXACT_ALARM" android:maxSdkVersion="32" />
    
    <!-- Android Alarm Manager Plus permissions -->
    <!-- SYSTEM_ALERT_WINDOW removed - causes app crashes on Android 16 when denied -->
    <!-- <uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW" /> -->

    <!-- Calendar permissions -->
    <uses-permission android:name="android.permission.READ_CALENDAR" />
    <uses-permission android:name="android.permission.WRITE_CALENDAR" />

    <!-- Storage permissions for data export/import -->
    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />
    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />
    <uses-permission android:name="android.permission.MANAGE_EXTERNAL_STORAGE" android:minSdkVersion="30" />
    
    <!-- File picker permissions -->
    <uses-permission android:name="android.permission.READ_MEDIA_IMAGES" />
    <uses-permission android:name="android.permission.READ_MEDIA_VIDEO" />
    <uses-permission android:name="android.permission.READ_MEDIA_AUDIO" />

    <!-- Network permissions for potential future features -->
    <uses-permission android:name="android.permission.INTERNET" />
    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
    
    <!-- Google Play Billing permission for in-app purchases -->
    <uses-permission android:name="com.android.vending.BILLING" />
    
    <!-- Battery optimization and background processing permissions -->
    <uses-permission android:name="android.permission.REQUEST_IGNORE_BATTERY_OPTIMIZATIONS" />

    <application
        android:label="HabitV8"
        android:name="${applicationName}"
        android:icon="@mipmap/ic_launcher"
        android:allowBackup="false"
        android:supportsRtl="true"
        android:enableOnBackInvokedCallback="true">

        <!-- Google Play Billing configuration -->
        <!-- Declare in-app products for Google Play Console detection -->
        <meta-data
            android:name="com.android.vending.billing.PRODUCT_IDS"
            android:value="premium_lifetime_access" />
        
        <!-- Alternative billing metadata approach -->
        <meta-data
            android:name="billing_product_premium_lifetime_access"
            android:value="@string/product_premium_lifetime_access" />

        <!-- Custom boot receiver that uses WorkManager instead of foreground services -->
        <receiver android:exported="false" android:name=".Android15CompatBootReceiver">
            <intent-filter>
                <action android:name="android.intent.action.BOOT_COMPLETED"/>
                <action android:name="android.intent.action.MY_PACKAGE_REPLACED"/>
                <action android:name="android.intent.action.QUICKBOOT_POWERON" />
                <category android:name="android.intent.category.DEFAULT" />
            </intent-filter>
        </receiver>
        
        <!-- Custom Alarm Service for continuous alarm playback -->
        <!-- Changed from mediaPlayback to specialUse to comply with Android 15+ restrictions -->
        <service
            android:name=".AlarmService"
            android:enabled="true"
            android:exported="false"
            android:foregroundServiceType="specialUse">
            
            <!-- Required property declaration for specialUse foreground service type -->
            <property 
                android:name="android.app.PROPERTY_SPECIAL_USE_FGS_SUBTYPE"
                android:value="alarm_clock" />
        </service>
            
        <!-- Alarm receiver for handling alarm broadcasts -->
        <receiver
            android:name=".AlarmReceiver"
            android:enabled="true"
            android:exported="false" />
        
        <!-- Alarm action receiver for handling alarm notification actions (Complete/Snooze) -->
        <receiver
            android:name=".AlarmActionReceiver"
            android:enabled="true"
            android:exported="false" />
        
        <!-- Widget update receiver for CRITICAL system events only -->
        <!-- BATTERY OPTIMIZATION: Removed SCREEN_ON, USER_PRESENT, DREAMING_STOPPED, POWER_* -->
        <!-- These events fire too frequently and drain battery unnecessarily -->
        <!-- Widget updates are primarily handled by Isar database listeners (event-driven) -->
        <receiver
            android:name=".WidgetUpdateReceiver"
            android:enabled="true"
            android:exported="false">
            <intent-filter>
                <!-- Critical time/date events that affect habit scheduling -->
                <action android:name="android.intent.action.TIME_CHANGED" />
                <action android:name="android.intent.action.DATE_CHANGED" />
                <action android:name="android.intent.action.TIMEZONE_CHANGED" />
                <action android:name="android.intent.action.TIME_SET" />
                <!-- Custom update trigger for manual widget refreshes -->
                <action android:name="com.habittracker.habitv8.UPDATE_WIDGETS" />
            </intent-filter>
        </receiver>
        
        <!-- Habit completion receiver for triggering widget updates -->
        <!-- This is triggered when habits are completed from notifications while app is closed -->
        <receiver
            android:name=".HabitCompletionReceiver"
            android:enabled="true"
            android:exported="false">
            <intent-filter>
                <action android:name="com.habittracker.habitv8.HABIT_COMPLETED" />
            </intent-filter>
        </receiver>

        <activity
            android:name=".MainActivity"
            android:exported="true"
            android:launchMode="singleTop"
            android:taskAffinity=""
            android:theme="@style/LaunchTheme"
            android:configChanges="orientation|keyboardHidden|keyboard|screenSize|smallestScreenSize|locale|layoutDirection|fontScale|screenLayout|density|uiMode"
            android:hardwareAccelerated="true"
            android:windowSoftInputMode="adjustResize">
            <!-- Specifies an Android theme to apply to this Activity as soon as
                 the Android process has started. This theme is visible to the user
                 while the Flutter UI initializes. After that, this theme continues
                 to determine the Window background behind the Flutter UI. -->
            <meta-data
              android:name="io.flutter.embedding.android.NormalTheme"
              android:resource="@style/NormalTheme"
              />
            <intent-filter>
                <action android:name="android.intent.action.MAIN"/>
                <category android:name="android.intent.category.LAUNCHER"/>
            </intent-filter>
        </activity>
        
        <!-- Home Widget Providers -->
        <receiver android:name=".HabitTimelineWidgetProvider"
            android:exported="true"
            android:label="Habit Timeline Widget">
            <intent-filter>
                <action android:name="android.appwidget.action.APPWIDGET_UPDATE" />
                <action android:name="android.appwidget.action.APPWIDGET_CONFIGURE" />
                <action android:name="android.appwidget.action.APPWIDGET_ENABLED" />
                <action android:name="android.appwidget.action.APPWIDGET_DISABLED" />
            </intent-filter>
            <meta-data android:name="android.appwidget.provider"
                android:resource="@xml/habit_timeline_widget_info" />
        </receiver>
        
        <receiver android:name=".HabitCompactWidgetProvider"
            android:exported="true"
            android:label="Habit Compact Widget">
            <intent-filter>
                <action android:name="android.appwidget.action.APPWIDGET_UPDATE" />
                <action android:name="android.appwidget.action.APPWIDGET_CONFIGURE" />
                <action android:name="android.appwidget.action.APPWIDGET_ENABLED" />
                <action android:name="android.appwidget.action.APPWIDGET_DISABLED" />
            </intent-filter>
            <meta-data android:name="android.appwidget.provider"
                android:resource="@xml/habit_compact_widget_info" />
        </receiver>
        
        <!-- Widget RemoteViewsServices for ListView scrolling -->
        <service android:name=".HabitTimelineWidgetService"
            android:permission="android.permission.BIND_REMOTEVIEWS"
            android:exported="false" />
        
        <service android:name=".HabitCompactWidgetService"
            android:permission="android.permission.BIND_REMOTEVIEWS"
            android:exported="false" />
        
        <!-- Don't delete the meta-data below.
             This is used by the Flutter tool to generate GeneratedPluginRegistrant.java -->
        <meta-data
            android:name="flutterEmbedding"
            android:value="2" />
    </application>
    <!-- Required to query activities that can process text, see:
         https://developer.android.com/training/package-visibility and
         https://developer.android.com/reference/android/content/Intent#ACTION_PROCESS_TEXT.

         In particular, this is used by the Flutter engine in io.flutter.plugin.text.ProcessTextPlugin. -->
    <queries>
        <intent>
            <action android:name="android.intent.action.PROCESS_TEXT"/>
            <data android:mimeType="text/plain"/>
        </intent>
    </queries>
</manifest>

